# AI股票分析系统 - 架构原理与使用指南

## 📋 项目概述

基于 **Streamlit + DeepSeek AI** 的复合多智能体股票分析系统，通过多个AI智能体协作，提供全方位的股票投资分析和决策建议。

### 核心特点
- **多智能体协作**：模拟证券公司分析师团队，各司其职
- **多市场支持**：A股、港股、美股全覆盖
- **实时监测**：自动监控价格变动，及时通知
- **自动化交易**：集成MiniQMT，支持自动交易执行
- **定时分析**：支持定时任务，自动运行分析

---

## 🏗️ 系统架构

### 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                    Streamlit Web界面                      │
│                   (app.py - 主应用)                       │
└──────────────────┬──────────────────────────────────────┘
                   │
       ┌───────────┼───────────┐
       │           │           │
┌──────▼───┐ ┌─────▼────┐ ┌───▼──────┐
│ 数据获取层 │ │ AI分析层 │ │ 服务层   │
└──────────┘ └──────────┘ └──────────┘
```

### 核心模块说明

#### 1. 数据获取层 (`stock_data.py`)
- **功能**：统一数据获取接口
- **数据源**：
  - A股：AKShare、Tushare（冗余机制）
  - 港股：AKShare
  - 美股：Yahoo Finance
- **能力**：
  - 股票基本信息
  - 历史行情数据
  - 财务数据（三大报表）
  - 技术指标计算（MA、RSI、MACD、KDJ等）
  - 资金流向数据
  - 新闻公告数据

#### 2. AI分析层 (`ai_agents.py`)
- **多智能体团队**：
  - 🔍 **技术分析师**：技术指标、趋势分析、支撑阻力
  - 📊 **基本面分析师**：财务分析、行业研究、估值评估
  - 💰 **资金面分析师**：资金流向、主力动向、市场情绪
  - ⚠️ **风险管理师**：风险评估、风险提示、风险控制
  - 📈 **市场情绪分析师**：情绪量化、市场热度
  - 📰 **新闻分析师**：新闻解读、舆情分析、事件影响

- **工作流程**：
```
数据获取 → 并行分析 → 团队讨论 → 综合决策 → 报告生成
```

#### 3. 服务层

**监测服务** (`monitor_service.py`)
- 后台线程持续监控
- 定时检查价格变动
- 触发条件判断（进场/止盈/止损）
- 自动发送通知

**通知服务** (`notification_service.py`)
- 邮件通知（QQ/163/Gmail）
- Webhook通知（钉钉/飞书）
- 网页通知

**配置管理** (`config_manager.py`)
- 环境变量管理
- 统一配置接口
- 支持Web界面配置

---

## 🎯 功能模块

### 1. 股票分析模块

#### 单个股票分析
- **输入**：股票代码、数据周期、选择分析师
- **输出**：多维度分析报告、投资建议、PDF报告
- **流程**：
  1. 获取股票数据和技术指标
  2. 并行运行选定的AI分析师
  3. 团队讨论综合意见
  4. 生成最终投资决策

#### 批量股票分析
- **模式**：顺序分析 / 多线程并行
- **功能**：
  - 横向对比多只股票
  - 按评级、涨跌幅筛选
  - 一键加入监测列表

### 2. 智瞰龙虎榜分析 (`longhubang_*`)

**5位AI分析师**：
- 🎯 游资行为分析师：识别活跃游资及其操作风格
- 📈 个股潜力分析师：挖掘次日大概率上涨的潜力股（核心）
- 🔥 题材追踪分析师：识别热点题材和炒作周期
- ⚠️ 风险控制专家：识别高风险股票和资金陷阱
- 👔 首席策略师：综合研判，给出最终推荐股票清单

**数据来源**：StockAPI龙虎榜接口

**使用场景**：短线交易、游资跟踪、题材炒作

### 3. 智策板块分析 (`sector_strategy_*`)

**4位AI智能体**：
- 🌐 宏观策略师：分析经济政策、新闻事件
- 📊 板块诊断师：分析板块走势、估值、轮动
- 💰 资金流向分析师：跟踪主力资金、北向资金
- 📈 市场情绪解码员：量化市场情绪、识别热点

**三维预测体系**：
- 板块多空预测（看多/看空/中性）
- 板块轮动预测（强势/潜力/衰退）
- 板块热度排行（最热/升温/降温）

**定时分析**：支持每日自动运行，邮件+Webhook推送

### 4. 主力选股 (`main_force_*`)

**工作流程**：
1. 从问财获取主力资金净流入前100名股票
2. 智能筛选（市值、涨跌幅）
3. AI团队整体分析
4. 资深研究员精选3-5只优质标的

**批量分析**：支持对TOP 10/20/30/50只股票进行深度分析

### 5. 实时监测 (`monitor_*`)

**功能**：
- 价格实时监控
- 触发条件设置（进场区间、止盈位、止损位）
- 多种通知方式（邮件、Webhook、网页）
- 通知历史记录

**监测流程**：
```
添加股票 → 设置参数 → 启动监测 → 后台监控 → 触发通知
```

### 6. 智能盯盘 (`smart_monitor_*`)

**AI自动化交易决策系统**：
- DeepSeek AI深度技术分析
- 24/7持续监控
- 自动交易执行（MiniQMT集成）
- 持仓管理（成本、盈亏）
- K线图可视化

### 7. 持仓分析 (`portfolio_*`)

**功能**：
- 持仓管理（添加/编辑/删除）
- 批量分析（顺序/并行模式）
- 定时分析（多时间点支持）
- 自动监测同步
- 历史记录追踪

---

## 🔧 技术实现原理

### 多智能体协作机制

```python
# 1. 并行运行各分析师
agents_results = {}
for agent_name, agent_func in agents.items():
    result = agent_func(data)
    agents_results[agent_name] = result

# 2. 团队讨论
discussion = conduct_team_discussion(agents_results)

# 3. 最终决策
final_decision = make_final_decision(discussion)
```

### 数据源冗余机制

系统实现了数据源自动切换机制：
- 主数据源失败时自动切换到备用数据源
- 提升数据获取成功率
- 支持配置优先级

### 监测服务实现

**后台线程模型**：
```python
class StockMonitorService:
    def _monitor_loop(self):
        while self.running:
            self._check_all_stocks()
            time.sleep(check_interval)
```

**触发条件判断**：
- 进场区间：价格在[min, max]范围内
- 止盈位：价格 >= 止盈价
- 止损位：价格 <= 止损价

### 通知系统

**多渠道通知**：
1. Webhook（钉钉/飞书）- 实时推送
2. 邮件 - 详细报告
3. 网页通知 - 备用方案

**通知去重**：同一股票60分钟内不重复发送相同类型通知

---

## 📖 使用指南

### 快速开始

#### 1. 环境配置

**方式一：Docker部署（推荐）**
```bash
# 构建镜像
docker build -f "Dockerfile国内源版" -t agentsstock1 .

# 运行容器
docker run -d -p 8503:8501 -v $(pwd)/.env:/app/.env --name agentsstock1 agentsstock1
```

**方式二：本地部署**
```bash
# 安装依赖
pip install -r requirements.txt

# 配置环境变量
cp .env.example .env
# 编辑.env文件，填入DEEPSEEK_API_KEY

# 启动系统
streamlit run app.py
```

#### 2. 配置API密钥

编辑 `.env` 文件：
```env
DEEPSEEK_API_KEY=your_api_key_here
EMAIL_ENABLED=false
WEBHOOK_ENABLED=false
```

#### 3. 访问系统

打开浏览器：http://localhost:8501 (本地) 或 http://localhost:8503 (Docker)

### 功能使用

#### 单个股票分析

1. **选择分析模式**：单个分析
2. **输入股票代码**：
   - A股：6位数字（如 000001）
   - 港股：1-5位数字或HK前缀（如 700 或 HK00700）
   - 美股：字母代码（如 AAPL）
3. **选择分析师**：勾选需要的分析师
4. **选择数据周期**：1y / 6mo / 3mo / 1mo
5. **开始分析**：点击"开始分析"按钮
6. **查看结果**：各分析师报告、团队讨论、最终决策

#### 批量股票分析

1. **选择分析模式**：批量分析
2. **输入股票代码**：每行一个，或逗号/空格分隔
3. **选择分析模式**：顺序分析（稳定）/ 并行分析（快速）
4. **开始批量分析**
5. **查看对比结果**：横向对比表格、详细卡片

#### 智瞰龙虎榜分析

1. **进入功能**：侧边栏 → 🎯 智瞰龙虎
2. **设置参数**：
   - 分析日期：建议选择昨天（T日数据）
   - AI模型：deepseek-chat（快速）/ deepseek-reasoner（深入）
3. **开始分析**：点击"🚀 开始分析"
4. **查看结果**：
   - 推荐股票：次日大概率上涨股票
   - AI分析师报告：5位分析师详细分析
   - 数据详情：游资排名、资金流向TOP20
   - 可视化图表：资金流向图、概念分布图

#### 智策板块分析

1. **进入功能**：侧边栏 → 🎯 智策板块
2. **选择AI模型**：deepseek-chat（快速）/ deepseek-reasoner（深入）
3. **开始分析**：点击"🚀 开始智策分析"
4. **查看结果**：
   - 核心预测：板块多空、轮动、热度
   - 智能体分析：4位分析师报告
   - 综合研判：团队讨论结果
5. **配置定时分析**：
   - 设置运行时间（如09:00）
   - 配置邮件/Webhook通知
   - 启动定时任务

#### 实时监测

1. **添加监测股票**：
   - 股票代码和名称
   - 投资评级（买入/持有/卖出）
   - 进场区间（min, max）
   - 止盈位、止损位
   - 检查间隔（秒）
2. **启动监测**：点击"▶️ 启动监测"
3. **查看通知**：价格触发条件时自动通知

#### 配置通知

**邮件通知**：
```env
EMAIL_ENABLED=true
SMTP_SERVER=smtp.qq.com
SMTP_PORT=587
EMAIL_FROM=your_email@qq.com
EMAIL_PASSWORD=your_auth_code
EMAIL_TO=receiver@example.com
```

**Webhook通知**：
```env
WEBHOOK_ENABLED=true
WEBHOOK_TYPE=dingtalk  # 或 feishu
WEBHOOK_URL=your_webhook_url
WEBHOOK_KEYWORD=股票  # 钉钉必需，飞书可留空
```

---

## ⚙️ 配置说明

### 环境变量配置

| 变量名 | 说明 | 必需 |
|--------|------|------|
| DEEPSEEK_API_KEY | DeepSeek API密钥 | ✅ |
| EMAIL_ENABLED | 启用邮件通知 | ❌ |
| SMTP_SERVER | SMTP服务器地址 | ❌ |
| EMAIL_FROM | 发送邮箱 | ❌ |
| EMAIL_PASSWORD | 邮箱授权码 | ❌ |
| EMAIL_TO | 接收邮箱 | ❌ |
| WEBHOOK_ENABLED | 启用Webhook通知 | ❌ |
| WEBHOOK_TYPE | Webhook类型（dingtalk/feishu） | ❌ |
| WEBHOOK_URL | Webhook地址 | ❌ |
| WEBHOOK_KEYWORD | 钉钉关键词 | ❌ |
| MINIQMT_ENABLED | 启用量化交易 | ❌ |
| MINIQMT_ACCOUNT_ID | 账户ID | ❌ |

### 数据源配置

系统支持数据源优先级配置：
- AKShare（主数据源）
- Tushare（备用数据源）

自动切换机制确保数据获取成功率。

---

## 🔍 常见问题

### 1. API Key错误
- 检查 `.env` 文件中的 `DEEPSEEK_API_KEY` 设置
- 确保API Key有效且有足够余额

### 2. 数据获取失败
- 检查网络连接
- 确认股票代码格式正确
- 可能是数据源临时不可用，稍后重试

### 3. 监测服务未运行
- 确认已点击"启动监测"按钮
- 检查后台线程是否正常
- 查看终端日志

### 4. 通知未收到
- 检查通知配置是否正确
- 使用测试功能验证配置
- 查看垃圾邮件箱（邮件通知）
- 确认Webhook机器人未被移出群聊

### 5. Docker部署问题
- 检查Docker是否正常运行
- 查看容器日志：`docker-compose logs -f`
- 确认 `.env` 文件已正确配置并挂载

---

## 📊 数据库结构

系统使用SQLite数据库存储：

**分析记录** (`stock_analysis.db`)
- `analysis_records`：分析历史记录

**监测数据** (`stock_monitor.db`)
- `monitored_stocks`：监测股票列表
- `price_history`：价格历史记录
- `notifications`：通知记录

**龙虎榜数据** (`longhubang.db`)
- `longhubang_records`：龙虎榜记录
- `analysis_reports`：分析报告
- `stock_tracking`：股票追踪

**板块策略数据** (`sector_strategy.db`)
- `analysis_reports`：分析报告
- `predictions`：预测记录

**持仓数据** (`portfolio_stocks.db`)
- `portfolio_stocks`：持仓股票
- `analysis_history`：分析历史

---

## 🚀 最佳实践

### 分析建议
1. **数据周期选择**：
   - 短线交易：1mo / 3mo
   - 中长线投资：6mo / 1y
2. **分析师选择**：
   - 技术面：技术分析师 + 资金面分析师
   - 基本面：基本面分析师 + 风险管理师
   - 全面分析：全部分析师
3. **批量分析数量**：建议不超过20只股票

### 监测建议
1. **检查间隔**：
   - 长线投资：180-300秒
   - 短线交易：30-60秒
2. **止盈止损设置**：
   - 止盈位：10-20%盈利目标
   - 止损位：5-10%止损线
3. **进场区间**：根据技术分析设定支撑位和阻力位

### 风险控制
1. ⚠️ AI分析仅供参考，不构成投资建议
2. ⚠️ 务必设置止损，控制风险
3. ⚠️ 市场有风险，投资需谨慎
4. ⚠️ 定期检查监测服务运行状态

---

## 📚 相关文档

- [快速开始指南](QUICK_START.md)
- [Docker部署指南](DOCKER_DEPLOYMENT.md)
- [智策板块使用指南](智策板块使用指南.md)
- [智瞰龙虎功能说明](智瞰龙虎功能说明.md)
- [主力选股使用指南](主力选股使用指南.md)
- [环境配置指南](环境配置快速指南.md)
- [Webhook通知配置指南](Webhook通知配置指南.md)

---

## 📝 更新日志

- **2025-10-26**：智能盯盘K线图可视化
- **2025-10-25**：优化数据源，专注技术面分析
- **2025-10-22**：主力选股批量分析历史记录功能
- **2025-10-21**：主力选股批量分析功能上线
- **2025-10-20**：持仓定时分析功能
- **2025-10-19**：风险管理师功能增强
- **2025-10-17**：智瞰龙虎板块分析系统上线
- **2025-10-15**：智策板块分析系统上线
- **2025-10-11**：优化数据获取
- **2025-10-10**：港股分析支持、主力选股功能上线

---

## ⚠️ 免责声明

本系统仅供学习和研究使用，不构成投资建议。股票投资有风险，入市需谨慎。使用本系统进行投资决策的风险由用户自行承担。

---

**技术支持**：山东科技大学 于舒馨  
**联系方式**：ws3101001@126.com

